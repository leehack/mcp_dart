name: Publish to pub.dev

on:
  workflow_run:
    workflows: ["Create Release"]
    types: [completed]

jobs:
  publish:
    runs-on: ubuntu-latest
    # Only run if the triggering workflow succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    permissions:
      id-token: write # Required for authentication using OIDC
    steps:
      - name: Download tag artifact
        uses: actions/download-artifact@v4
        with:
          name: release-tag
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}

      - name: Get tag from artifact
        id: get-tag
        run: |
          TAG=$(cat tag.txt)
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "ğŸ·ï¸ Tag from artifact: $TAG"

      - uses: actions/checkout@v4
        with:
          ref: ${{ steps.get-tag.outputs.tag }}

      - name: Determine package from tag
        id: package-info
        run: |
          TAG="${{ steps.get-tag.outputs.tag }}"
          echo "ğŸ·ï¸ Processing tag: $TAG"
          
          if [[ "$TAG" == mcp_dart_cli-v* ]]; then
            echo "working_directory=packages/mcp_dart_cli" >> "$GITHUB_OUTPUT"
            echo "ğŸ“¦ Package: mcp_dart_cli"
          elif [[ "$TAG" == v* ]]; then
            echo "working_directory=." >> "$GITHUB_OUTPUT"
            echo "ğŸ“¦ Package: mcp_dart"
          else
            echo "âŒ Unknown tag format: $TAG"
            exit 1
          fi

      - uses: dart-lang/setup-dart@v1

      - name: Install dependencies
        working-directory: ${{ steps.package-info.outputs.working_directory }}
        run: dart pub get

      - name: Publish to pub.dev
        working-directory: ${{ steps.package-info.outputs.working_directory }}
        run: dart pub publish --force
